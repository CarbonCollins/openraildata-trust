"use strict";
const stompit = require('stompit');
const zlib  = require('zlib');
const connectOptions = {
    'host': 'datafeeds.nationalrail.co.uk',
    'port': 61613,
    'connectHeaders':{
        'host': '/',
        'login': 'd3user',
        'passcode': 'd3password',
        'heart-beat': '5000,5000'
    }
};

stompit.connect(connectOptions, function(error, client) {

    if(error){
        console.log('Unable to connect: ' + error.message);
        return;
    }

    const subscribeParams = {
        'destination': '/queue/QUEUE_NAME_HERE',
        'ack': 'client-individual'
    };


    client.subscribe(subscribeParams, function(error, message){

        const read = function(){
            let chunk;
            while(null !== (chunk = message.read())){
                zlib.gunzip(chunk, function (error, response) {

                    if (error) {
                        console.log(message.headers)
                        console.log(error)
                    } else {
                        console.log(message.headers.FilterHeaderLevel)
                        console.log(response.toString());
                    }
                });
            }
        };

        message.on('readable', read);

        message.on('end', function(){
            client.ack(message);
        });
    });
});